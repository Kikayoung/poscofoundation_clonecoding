$(document).ready(function(){
	
	$("#contactusCloseBtn").click(function(){
		$("#opinion").hide();
	});

	$('#contactusSubmitBtn').click(function() {
        $("#contactForm").submit(); return false;
    });	
	
	$.validator.addMethod("pwchange", function(value, element) {
        var pw_chk = $("#pw_chk").prop("checked");
        if(pw_chk) {
            var pattern1 = /[0-9]/;	// 숫자
            var pattern2 = /[a-zA-Z]/;	// 문자ex
            var pattern3 = /[~!@#$%^&*()_+|<>?:{}]/;	// 특수문자
            if(!pattern1.test(value) || !pattern2.test(value) || !pattern3.test(value) || value.length < 8) {
                return false;
            } else {
                return true;
            }
        } else {
            return true;
        }
    },  jQuery.validator.messages.pwchange);
	
	// form check
    $("#contactForm").submit(function(e) {
        e.preventDefault();
    }).validate({
        errorClass: "validate-error",
        rules: {            	
        	cuntactusName:{required: true, minlength: 2},
        	cuntactusEmail:{required: true, minlength: 5, email : true},
        	cuntactusType:{required: true}, 
        	cuntactusTitle:{required: true, minlength: 5},        	            	            	
        },
        messages: {            	
        	cuntactusName:{required: "작성자를 입력해주세요." , minlength: "작성자는 {0}자 이상입니다" },
        	cuntactusEmail:{required: "이메일을 입력해주세요" , minlength: "이메일은 {0}자 이상입니다", email : "올바른 이메일 주소를 입력해주세요." },        	        	
        	cuntactusType:{required: "분류를 선택해주세요." },
        	cuntactusTitle:{required: "제목을 입력해주세요." , minlength: "제목은 {0}자 이상입니다" },            	            	
        },
        errorPlacement: function(error, element) {
            if ($('#' + element.attr('id') + '_error').length > 0) {
                $('#' + element.attr('id') + '_error').text(error.text());
            } else if  (element.attr("id") == "bsZipcode" || element.attr("id") == "bsId") {
            	error.insertAfter(element.parent());                	 
            } else {
            	error.insertAfter(element);
            }                
        },
        submitHandler: function(e){            
        	
        	var agreeChk = $(":input:radio[name=agreeChk]:checked").val();
        	if(agreeChk == "N") {
        		alert("약관에 동의후 문의가 가능합니다."); return false;
        	}
        	
        	if(confirm("의견을 보내시겠습니까?")) {
        		//ajaxProcessContactus ({url:'/front/contactus/optionSend.proc', form_id:'contactForm', fileup:'1', func:'contactRst' });
        		ajaxProcessContactus ({url:'https://www.poscofoundation.org/front/contactus/optionSend.proc', form_id:'contactForm', fileup:'1', func:'contactRst' });
        	} else {
        		return false;
        	}        	
        }
    });
	
});


var contactRst = function(d) {
    console.log(!isUndefined(d));
	var result = "";
	var r = "";

	if(!isUndefined(d)) {
		if(d.rst == "Y") {
			alert('의견이 발송 되었습니다.');
			location.reload();
			$("#opinion").hide();
		} else {
			if(!isUndefined(d.msg)) {
				alert(d.msg);
			} else {
				alert('전송 실패하셨습니다. 잠시후 다시 시도해주세요!');
			}
			$("#contactusSubmitBtn").show();
            $("#contactusCloseBtn").html("취소");
		}
	} else {
		alert('전송 실패하셨습니다. 잠시후 다시 시도해주세요!');
		$("#contactusSubmitBtn").show();
        $("#contactusCloseBtn").html("취소");
	}
}


function isUndefined (data) {
    return (data === undefined)? true : false;
}

function ajaxProcessContactus () {
    var s = eval(arguments[0]);
    var data = '';
    var add_data = '';
    var ret = '';
    var load_bar = '';
    var return_type = 'json';

    if (!isUndefined(s.form_id)) {
        add_data = $("#" + s.form_id).serialize();
    }

    if (!isUndefined(s.data)) {
        data = s.data;
    }

    if (!isUndefined(s.load_bar)) {
        load_bar = s.load_bar;
    }

    if (add_data) data += '&' + add_data;
    
    if (!isUndefined(s.return_type)) {
    	return_type = s.return_type;
    }
    
    var async = (s.async)? true : false;
    async = true;
    var option = {
        type:  "POST",
        url: s.url,
        dataType: return_type,
        async: async,
        beforeSend:function(){
            console.log("메일 발송중입니다.");
            $("#contactusSubmitBtn").hide();
            $("#contactusCloseBtn").html("전송중입니다.");
        },
        data: data,
        timeout: 100000,
        success: function(result) {            
            if(s.func != undefined) {
                var fn = eval(s.func);
                fn(result);
            }
        },
        error : function(x,e){
            alert ('데이터 전송중에 문제가 발생하였습니다!');
        }
    }
    var rst = '';
    if (s.fileup) {
        rst = $('#' + s.form_id).ajaxSubmit(option);
    } else {
        rst = $.ajax(option);
    }

    if (!async) {
        return eval("(" + rst.responseText + ")");
    }
}